<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FilmApp | Film Detay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .trailer-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .trailer-iframe {
      width: 80%;
      height: 70%;
      border: none;
    }
    .close-trailer {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #dc3545;
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .star-rating {
      font-size: 24px;
      cursor: pointer;
    }
    .star-rating .star {
      color: #ddd;
      transition: color 0.2s;
    }
    .star-rating .star:hover,
    .star-rating .star.active {
      color: #ffc107;
    }
    .user-rating {
      background: linear-gradient(45deg, #1a1a1a, #2d2d2d);
      border-radius: 10px;
      padding: 20px;
    }
    .rating-stats {
      background: linear-gradient(45deg, #dc3545, #e83e8c);
      color: white;
      border-radius: 10px;
      padding: 15px;
    }
  </style>
</head>
<body class="bg-dark text-white">
<script>
  const user = JSON.parse(localStorage.getItem('loggedUser'));
  if (!user) {
    alert('Bu sayfayÄ± gÃ¶rmek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.');
    window.location.href = 'login-panel.html';
  }
</script>

  <!-- Fragman Container -->
  <div class="trailer-container" id="trailerContainer">
    <button class="close-trailer" onclick="closeTrailer()">Ã—</button>
    <iframe class="trailer-iframe" id="trailerIframe" 
            src="" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen>
    </iframe>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-black fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand text-danger fw-bold fs-3" href="index.html">FilmApp</a>
      <button class="navbar-toggler bg-danger" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
         <li class="nav-item"><a class="nav-link text-white" href="index.html">Ana Sayfa</a></li>
          <li class="nav-item"><a class="nav-link text-white" href="index.html#popular-films">PopÃ¼ler</a></li>
          <li class="nav-item"><a class="nav-link text-white" href="index.html#new-films">Yeni</a></li>
          <li class="nav-item"><a class="nav-link text-white" href="favoriler.html">Favoriler</a></li>
          <li class="nav-item"><a class="nav-link text-white" href="login-panel.html">GiriÅŸ Yap/Ãœye Ol</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle text-white" href="#" id="turlerDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              TÃ¼rler
            </a>
            <ul class="dropdown-menu dropdown-menu-end bg-dark" aria-labelledby="turlerDropdown">
              <li><a class="dropdown-item text-white" href="turler.html#aksiyon">Aksiyon</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#gerilim">Gerilim</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#korku">Korku</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#polisiye">Polisiye</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#bilim-kurgu">Bilim Kurgu</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#belgesel">Belgesel</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#animasyon">Animasyon</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#anime">Anime</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#dram">Dram</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#komedi">Komedi</a></li>
              <li><a class="dropdown-item text-white" href="turler.html#macera">Macera</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Film Detay Ä°Ã§erik -->
  <div class="container mt-5 pt-5">
    <div class="row">
      <div class="col-md-4">
        <img src="https://via.placeholder.com/400x600" id="film-image" class="img-fluid rounded-3" alt="Film">
      </div>
      <div class="col-md-8">
        <h2 id="film-title">Film BaÅŸlÄ±ÄŸÄ±</h2>
        <p class="text-secondary" id="film-category">Kategori: Aksiyon</p>
        <p class="text-secondary" id="film-year">YÄ±l: 2025</p>
        
        <!-- Puanlama BÃ¶lÃ¼mÃ¼ -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="rating-stats text-center">
              <h3 id="average-rating">8.5</h3>
              <div class="star-rating mb-2">
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star-half-alt text-warning"></i>
              </div>
              <small id="total-ratings">1,234 deÄŸerlendirme</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="user-rating">
              <h5>Filmi Puanla</h5>
              <div class="star-rating mb-3" id="user-rating-stars">
                <i class="far fa-star star" data-rating="1"></i>
                <i class="far fa-star star" data-rating="2"></i>
                <i class="far fa-star star" data-rating="3"></i>
                <i class="far fa-star star" data-rating="4"></i>
                <i class="far fa-star star" data-rating="5"></i>
                <i class="far fa-star star" data-rating="6"></i>
                <i class="far fa-star star" data-rating="7"></i>
                <i class="far fa-star star" data-rating="8"></i>
                <i class="far fa-star star" data-rating="9"></i>
                <i class="far fa-star star" data-rating="10"></i>
              </div>
              <p id="user-rating-text" class="text-secondary">PuanÄ±nÄ±zÄ± seÃ§in</p>
              <button class="btn btn-warning btn-sm" id="submit-rating" disabled>PuanÄ± GÃ¶nder</button>
              <button class="btn btn-outline-secondary btn-sm" id="remove-rating" style="display: none;">PuanÄ±mÄ± KaldÄ±r</button>
            </div>
          </div>
        </div>

        <p id="film-description" class="mb-4">
          Film hakkÄ±nda kÄ±sa bir aÃ§Ä±klama burada yer alacak.
        </p>
        <button class="btn btn-danger mb-2" id="watch-trailer">ğŸ¬ FragmanÄ± Ä°zle</button>
        <button class="btn btn-outline-danger" id="add-fav">â­ Favorilere Ekle</button>
      </div>
    </div>

    <!-- KullanÄ±cÄ± YorumlarÄ± -->
    <div class="row mt-5">
      <div class="col-12">
        <h4 class="text-danger mb-4">ğŸ‘¥ KullanÄ±cÄ± YorumlarÄ±</h4>
        <div id="user-reviews">
          <!-- Yorumlar buraya eklenecek -->
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center py-3 mt-5 bg-black text-secondary">
    Â© 2025 FilmApp | TÃ¼m HaklarÄ± SaklÄ±dÄ±r
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let currentFilm = null;
    let userRating = 0;

    // Film detaylarÄ±nÄ± yÃ¼kle
    const filmId = Number(localStorage.getItem('detailFilmId'));

    // Puanlama sistemini baÅŸlat
    function initializeRatingSystem() {
      const stars = document.querySelectorAll('#user-rating-stars .star');
      const submitBtn = document.getElementById('submit-rating');
      const removeBtn = document.getElementById('remove-rating');
      const ratingText = document.getElementById('user-rating-text');

      // YÄ±ldÄ±zlara tÄ±klama event'i
      stars.forEach(star => {
        star.addEventListener('click', function() {
          userRating = parseInt(this.getAttribute('data-rating'));
          updateStarDisplay();
          submitBtn.disabled = false;
          ratingText.textContent = `SeÃ§ilen puan: ${userRating}/10`;
        });

        star.addEventListener('mouseover', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          highlightStars(rating);
        });
      });

      // YÄ±ldÄ±zlarÄ±n Ã¼zerinden Ã§Ä±kÄ±nca
      document.getElementById('user-rating-stars').addEventListener('mouseleave', function() {
        updateStarDisplay();
      });

      // Puan gÃ¶nderme
      submitBtn.addEventListener('click', function() {
        submitUserRating();
      });

      // Puan kaldÄ±rma
      removeBtn.addEventListener('click', function() {
        removeUserRating();
      });

      // KullanÄ±cÄ±nÄ±n Ã¶nceki puanÄ±nÄ± kontrol et
      checkUserRating();
    }

    // YÄ±ldÄ±zlarÄ± gÃ¼ncelle
    function updateStarDisplay() {
      const stars = document.querySelectorAll('#user-rating-stars .star');
      stars.forEach(star => {
        const starRating = parseInt(star.getAttribute('data-rating'));
        if (starRating <= userRating) {
          star.classList.remove('far');
          star.classList.add('fas', 'active');
        } else {
          star.classList.remove('fas', 'active');
          star.classList.add('far');
        }
      });
    }

    // YÄ±ldÄ±zlarÄ± vurgula (hover iÃ§in)
    function highlightStars(rating) {
      const stars = document.querySelectorAll('#user-rating-stars .star');
      stars.forEach(star => {
        const starRating = parseInt(star.getAttribute('data-rating'));
        if (starRating <= rating) {
          star.classList.remove('far');
          star.classList.add('fas', 'active');
        } else {
          star.classList.remove('fas', 'active');
          star.classList.add('far');
        }
      });
    }

    // KullanÄ±cÄ± puanÄ±nÄ± kontrol et
    function checkUserRating() {
      const ratings = JSON.parse(localStorage.getItem('filmRatings')) || {};
      const userRatings = ratings[user.username] || {};
      
      if (userRatings[filmId]) {
        userRating = userRatings[filmId];
        updateStarDisplay();
        document.getElementById('user-rating-text').textContent = `Mevcut puanÄ±nÄ±z: ${userRating}/10`;
        document.getElementById('submit-rating').style.display = 'none';
        document.getElementById('remove-rating').style.display = 'inline-block';
      }
    }

    // KullanÄ±cÄ± puanÄ±nÄ± gÃ¶nder
    function submitUserRating() {
      if (!userRating) return;

      const ratings = JSON.parse(localStorage.getItem('filmRatings')) || {};
      if (!ratings[user.username]) {
        ratings[user.username] = {};
      }
      
      ratings[user.username][filmId] = userRating;
      localStorage.setItem('filmRatings', JSON.stringify(ratings));

      // Ortalama puanÄ± gÃ¼ncelle
      updateAverageRating();

      alert(`"${currentFilm.title}" filmine ${userRating} puan verdiniz!`);
      document.getElementById('submit-rating').style.display = 'none';
      document.getElementById('remove-rating').style.display = 'inline-block';
      document.getElementById('user-rating-text').textContent = `Mevcut puanÄ±nÄ±z: ${userRating}/10`;
    }

    // KullanÄ±cÄ± puanÄ±nÄ± kaldÄ±r
    function removeUserRating() {
      const ratings = JSON.parse(localStorage.getItem('filmRatings')) || {};
      if (ratings[user.username]) {
        delete ratings[user.username][filmId];
        localStorage.setItem('filmRatings', JSON.stringify(ratings));
      }

      userRating = 0;
      updateStarDisplay();
      document.getElementById('submit-rating').style.display = 'inline-block';
      document.getElementById('submit-rating').disabled = true;
      document.getElementById('remove-rating').style.display = 'none';
      document.getElementById('user-rating-text').textContent = 'PuanÄ±nÄ±zÄ± seÃ§in';

      // Ortalama puanÄ± gÃ¼ncelle
      updateAverageRating();

      alert('PuanÄ±nÄ±z kaldÄ±rÄ±ldÄ±!');
    }

    // Ortalama puanÄ± hesapla ve gÃ¶ster
    function updateAverageRating() {
      const ratings = JSON.parse(localStorage.getItem('filmRatings')) || {};
      let total = 0;
      let count = 0;

      // TÃ¼m kullanÄ±cÄ±larÄ±n bu film iÃ§in puanlarÄ±nÄ± topla
      Object.keys(ratings).forEach(username => {
        if (ratings[username][filmId]) {
          total += ratings[username][filmId];
          count++;
        }
      });

      const average = count > 0 ? (total / count).toFixed(1) : currentFilm.rating;
      document.getElementById('average-rating').textContent = average;
      document.getElementById('total-ratings').textContent = `${count} deÄŸerlendirme`;

      // YÄ±ldÄ±zlarÄ± gÃ¼ncelle
      updateAverageStars(average);
    }

    // Ortalama puan yÄ±ldÄ±zlarÄ±nÄ± gÃ¼ncelle
    function updateAverageStars(average) {
      const stars = document.querySelectorAll('.rating-stats .fa-star');
      const numericAverage = parseFloat(average);
      
      stars.forEach((star, index) => {
        if (numericAverage >= (index + 1) * 2) {
          star.className = 'fas fa-star text-warning';
        } else if (numericAverage >= (index * 2) + 1) {
          star.className = 'fas fa-star-half-alt text-warning';
        } else {
          star.className = 'far fa-star text-warning';
        }
      });
    }

    // Film detaylarÄ±nÄ± yÃ¼kle
    fetch('data/filmler.json')
      .then(res => res.json())
      .then(filmler => {
        const film = filmler.find(f => f.id === filmId);
        if (!film) {
          console.error('Film bulunamadÄ±, ID:', filmId);
          return;
        }

        currentFilm = film;

        // Sayfadaki bilgileri gÃ¼ncelle
        document.getElementById('film-image').src = film.image;
        document.getElementById('film-title').textContent = film.title;
        document.getElementById('film-category').textContent = `Kategori: ${film.category}`;
        document.getElementById('film-year').textContent = `YÄ±l: ${film.year}`;
        document.getElementById('film-description').textContent = film.description || 'AÃ§Ä±klama bulunmuyor.';
        
        // Ortalama puanÄ± gÃ¶ster
        updateAverageRating();
        
        // Fragman butonunu kontrol et
        const trailerBtn = document.getElementById('watch-trailer');
        if (film.trailer) {
          trailerBtn.style.display = 'inline-block';
        } else {
          trailerBtn.style.display = 'none';
        }

        // Puanlama sistemini baÅŸlat
        initializeRatingSystem();
      })
      .catch(err => console.error('Film detaylarÄ± yÃ¼klenemedi:', err));

    // Fragman aÃ§ma fonksiyonu
    function openTrailer() {
      if (currentFilm && currentFilm.trailer) {
        const iframe = document.getElementById('trailerIframe');
        const container = document.getElementById('trailerContainer');
        
        iframe.src = currentFilm.trailer + '?autoplay=1';
        container.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    // Fragman kapatma fonksiyonu
    function closeTrailer() {
      const iframe = document.getElementById('trailerIframe');
      const container = document.getElementById('trailerContainer');
      
      iframe.src = '';
      container.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Fragman butonuna tÄ±klama event'i
    document.getElementById('watch-trailer').addEventListener('click', openTrailer);

    // ESC tuÅŸu ile kapatma
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeTrailer();
      }
    });

    // Container'a tÄ±klayarak kapatma
    document.getElementById('trailerContainer').addEventListener('click', function(e) {
      if (e.target === this) {
        closeTrailer();
      }
    });

    // Favorilere ekleme
    document.getElementById('add-fav').addEventListener('click', () => {
      if (!currentFilm) return;
      
      const film = {
        id: currentFilm.id,
        title: currentFilm.title,
        category: currentFilm.category,
        image: currentFilm.image,
        rating: currentFilm.rating,
        year: currentFilm.year
      };
      
      let favs = JSON.parse(localStorage.getItem('favorites')) || [];
      if(!favs.some(f => f.id === film.id)){
        favs.push(film);
        localStorage.setItem('favorites', JSON.stringify(favs));
        alert(`${film.title} favorilere eklendi!`);
      } else {
        alert(`${film.title} zaten favorilerde!`);
      }
    });
  </script>
</body>
</html>